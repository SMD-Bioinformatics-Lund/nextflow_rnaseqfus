// indentation is 2 spaces

singularity{
  enabled                     = true	
  runOptions                  = '--bind /fs1/ --bind /local/ --bind /fs2/ --bind /mnt/' 
}

env{
  SENTIEON_LICENSE            = '10.139.0.101:8990'
}

process.shell                 = ['/bin/bash', '-euo', 'pipefail']

params {

  /*  results dir */
  resultsdir                  = "/fs1/results"
  dev                         = false
  dev_suffix                  = ''
  if (params.dev) {
    dev_suffix                = "_dev"
  }
  container_dir               = "/fs1/resources/containers"
  data_refbase                = "/fs1/resources/ref/hg38/data"
  container                   = "${params.container_dir}/rnaseqfus_active.sif"
  queue                       = 'high'

  /*  UMI information */
  umi                         = false
  fastp                       = false

  /*  Sumsampling parameters */
  subsampling                 = true
  subsampling_number          = 1000000000

  /*  Arriba parameters */
  refbase                     = "/fs1/resources/ref/hg38/star/star_hg38_nochr_index_2.7.8a/"
  fasta                       = "/fs1/resources/ref/hg38/fasta/GCA_000001405.15_GRCh38_no_alt_analysis_set_nochr.fna"
  fastaIndex                  = "/fs1/resources/ref/hg38/fasta/"
  gtf                         = "${data_refbase}/gtf/gencode.v38.annotation_nochr.gtf"
  blacklists                  = "${data_refbase}/arriba/blacklist_hg38_GRCh38_v2.3.0.tsv.gz"
  knownfusions                = "${data_refbase}/arriba/known_fusions_hg38_GRCh38_v2.3.0.tsv.gz"
  proteinDomains              = "${data_refbase}/arriba/protein_domains_hg38_GRCh38_v2.3.0.gff3"
  cytobands                   = "${data_refbase}/arriba/cytobands_hg38_GRCh38_v2.3.0.tsv"
  fusiongenelist_WTS          = "/fs1/resources/ref/hg38/data/fusions_genelist/20251125_WTS_FusiongeneList"

  /*  Starfusion parameters */
  pairEnd                     = true // Currently run in the pairedEND mode with 2x150 bp setup
  refbase2                    = "${data_refbase}/st_rna/ctat_genome_lib_build_dir/"

  /*  Fusion Catcher parameters */
  fusioncatcher               = "${data_refbase}/st_rna/human_v102/"

  /*  IGH-DUX4 workflow parameters  */
  customigh                   = false
  ighdux4                     = "${data_refbase}/IGH_DUX4/IGH_DUX4-reg_grch38.bed"

  /*  MET and EGFR exon_skipping */
  exon_skipping               = false
  metEgfr                     = "${data_refbase}/exon_skipping/Twist_RNA_Design5.hg38.annotated.bed"

  /* Filter genes based on the designed geneprobes  */
  stgenePanel_file            = "${data_refbase}/st_rna/ST_RNA_genes.tsv"

  /* Rescue discarded gene fusion from arriba */
  arriba_filter               = false

  /*  QC parameters */
  hg38_sizes                  = '/fs1/resources/ref/hg38/fasta/GCA_000001405.15_GRCh38_no_alt_analysis_set_nochr.chrom.sizes'
  ref_rseqc_bed               = "${data_refbase}/RseQC/Homo_sapiens.GRCh38.79.bed"
  ref_bed                     = "${data_refbase}/provider/HPA_1000G_final_38.bed"
  ref_bedXY                   = "${data_refbase}/provider/xy_38.bed"

  /* Salmon Expression profiles */
  quant                       = true
  ref_salmon                  = "${data_refbase}/transcriptome_ref/Homo_sapiens.GRCh38.cdna.all.fa"
  salmon_index_dir            = "${data_refbase}/transcriptome_ref/salmon_index/"

  /* Hem - Classifier */
  classifier                  = true
  hem_classifier_salmon       = "${data_refbase}/fusion_classifier/hem_classifier.salmon.20190510.RData"
  ensembl_annotation          = "${data_refbase}/fusion_classifier/ensembl_annotation.RData"
  reference_expression_all    = "${data_refbase}/extract_expr_ref/reference_expression.all.tsv"
  genesOfInterest              = "${data_refbase}/extract_expr_ref/genes_of_interest.tsv"

}

profiles {
  
  GMS_ST_RNA_FUSION{

    params.outdir             = "${params.resultsdir}${params.dev_suffix}"
    params.subdir             = "solid_ST_RNA"
    params.tmp_dir            = "/local/scratch/"
    params.crondir            = "${params.outdir}/cron/"
    
    /* sample upto 10M reads */
    params.subsampling        = true
    params.subsampling_number = 100000000 // Validation reads upto 10 mil 
    params.stgenePanel_file   = "/fs1/resources/ref/hg38/data/st_rna/ST_RNA_genes.tsv"

    /* PIPELINE PARAMS */
    params.umi                = false 
    params.fastp              = true 
    params.coyote_group       = "solidRNA_GMSv5"
    params.assay              = "rnaseqsolid"
    params.cdm                = "solidRNA_GMSv5"

    //  MET and EGFR exon skipping/
    params.exon_skipping      = true
    params.metEgfr            = "/fs1/resources/ref/hg38/data/exon_skipping/Twist_RNA_Design5.hg38.annotated.bed"

    /*  QC parameters */
    params.ref_flat           = "/fs1/resources/ref/hg38/data/st_rna/ST_RNA_genes_annotation.refflat"
    params.probes             = "/fs1/resources/ref/hg38/data/st_rna/Twist_RNA.Design5.nochr.targets.interval_list"
    params.targets            = "/fs1/resources/ref/hg38/data/st_rna/Twist_RNA.Design5.nochr.targets.interval_list"
    params.panel_bed          = "/fs1/resources/ref/hg38/data/st_rna/sorted_ST_RNA_genes.bed"

    params.customDuxIgh       = false
    ighdux4                   = "/fs1/resources/ref/hg38/data/IGH_DUX4/IGH_DUX4-reg_grch38.bed"
    params.arriba_filter      = false

    process {
      executor                = 'slurm'
      queue                   = params.queue
      time                    = 48.h
      container               = params.container
    }
  }

  TWIST_RNA_FUSION {

    params.outdir             = "${params.resultsdir}${params.dev_suffix}"
    params.subdir             = "twistrnafusionv1-0" // change this to the real subgroup "RNA-fusion" that needs to be done "rnafusion_ST_Panel_RNA" 
    params.tmp_dir            = "/local/scratch/"
    params.crondir            = "${params.outdir}/cron/"
    
    /* Subsampled to 30M  reads */
    params.subsampling        = true
    params.subsampling_number = 65000000 // Validation reads uptp 30mil
    params.stgenePanel_file   = "/fs1/resources/ref/hg38/data/st_rna/Cegat_RNA_genes.tsv"

    /* PIPELINE PARAMS */    
    params.umi                = false 
    params.fastp              = true
    params.coyote_group       = "twistrnafusionv1-0"  // Change to RNA-fusion later when added
    params.assay              = "RNA-fusionpanel"     // rnaseqfusionpanel
    params.cdm                = "twistrnafusionv1-0"

    /*MET and EGFR exon skipping */
    params.exon_skipping      = true
    params.metEgfr            = "/fs1/resources/ref/hg38/data/exon_skipping/Twist_RNA_Design5.hg38.annotated.bed"

    /* qc parameters */
    params.ref_flat           = "/fs1/resources/ref/hg38/data/st_rna/Cegat_genes_annotation.refflat"
    params.probes             = "/fs1/resources/ref/hg38/data/st_rna/Cegat.targets.interval_list"
    params.targets            = "/fs1/resources/ref/hg38/data/st_rna/Cegat.targets.interval_list"
    params.panel_bed          = "/fs1/resources/ref/hg38/data/st_rna/sorted_cegat_genes.bed"

    params.customDuxIgh       = false
    ighdux4                   = "/fs1/resources/ref/hg38/data/IGH_DUX4/IGH_DUX4-reg_grch38.bed"

    params.arriba_filter      = false

    process {
      executor                = 'slurm'
      queue                   = params.queue
      time                    = 48.h
      container               = params.container
    }
  }

  WTS_RNA_FUSION {
    params.outdir             = "${params.resultsdir}${params.dev_suffix}"
    params.subdir             = "rnaseq_fusion" 
    params.tmp_dir            = "/local/scratch/"
    params.crondir            = "${params.outdir}/cron/"
    
    /* Subsampled to 30M  reads */
    params.subsampling        = true
    params.subsampling_number = 85000000   // Change the reads num to 100 mill or 85 mill
    // Needs to change this to appropriate genes for the fusion for both Hema and Solid fusions
    params.stgenePanel_file   = "${params.refbase}/st_rna/Cegat_RNA_genes.tsv"
    params.fusioncatcher      = "${params.data_refbase}/fusioncatcher/human_v98/"

    /* PIPELINE PARAMS */
    params.umi                = false 
    params.fastp              = false
    params.coyote_group       = "fusion"  // Change to RNA-fusion later when added
    params.assay              = "wts_rnafusion"     // rnaseqfusionpanel
    params.cdm                = "rnaseq-fusion"

    /*MET and EGFR exon skipping */
    params.exon_skipping      = false
    params.metEgfr            = "${params.data_refbase}/exon_skipping/Twist_RNA_Design5.hg38.annotated.bed"

    params.customDuxIgh       = true
    ighdux4                   = "${params.data_refbase}/IGH_DUX4/IGH_DUX4-reg_grch38.bed"

    params.arriba_filter      = true
    
    /* Change this parameter for the rnaseq whole transcriptp,ocs qc parameters */
    params.ref_flat           = "/fs1/saile/prj/data/resources/WTS/gencode.v38.annotation.refflat"
    // params.ref_flat           = "${params.data_refbase}/st_rna/Cegat_genes_annotation.refflat"

    params.probes             = "/fs1/saile/prj/data/resources/WTS/gencode.v38.interval_list"
    // params.probes             = "${params.data_refbase}/st_rna/Cegat.targets.interval_list"

    params.targets            = "/fs1/saile/prj/data/resources/WTS/gencode.v38.interval_list"
    // params.targets            = "${params.data_refbase}/st_rna/Cegat.targets.interval_list"

    params.panel_bed          = "/fs1/saile/prj/data/resources/WTS/sorted_gencode_v38.genes.bed"
    // params.panel_bed          = "${params.data_refbase}/st_rna/sorted_cegat_genes.bed"

    /* Expression profiles */
    params.quant              = true
    
    /* Salmon */
    params.classifier         = true
    params.ref_salmon         = "${params.data_refbase}/transcriptome_ref/Homo_sapiens.GRCh38.cdna.all.fa"
    params.salmon_index_dir   = "${params.data_refbase}/transcriptome_ref/salmon_index/"

    /* Hem - Classifier */
    params.hem_classifier_salmon    = "${params.data_refbase}/fusion_classifier/hem_classifier.salmon.20190510.RData"
    params.ensembl_annotation       = "${params.data_refbase}/fusion_classifier/ensembl_annotation.RData"
    params.reference_expression_all = "${params.data_refbase}/extract_expr_ref/reference_expression.all.tsv"
    params.genesOfInterest           = "${params.data_refbase}/extract_expr_ref/genes_of_interest.tsv"
    
    process {
      executor                = 'slurm'
      queue                   = 'grace-normal'
      time                    = 48.h
      container               = params.container
    }
  
  }
  
  TEST_PROFILE {
 
    params.outdir             = "${params.resultsdir}${params.dev_suffix}"
    params.subdir             = "rnaseq_fusion" 
    params.tmp_dir            = "/local/scratch/"
    params.crondir            = "${params.outdir}/cron/"
    
    /* Subsampled to 30M  reads */
    params.subsampling        = true
    params.subsampling_number = 1000000   // Change the reads num to 100 mill or 85 mill
    // Needs to change this to appropriate genes for the fusion for both Hema and Solid fusions
    params.stgenePanel_file   = "${params.refbase}/st_rna/Cegat_RNA_genes.tsv"
    params.fusioncatcher      = "${params.data_refbase}/fusioncatcher/human_v98/"

    /* PIPELINE PARAMS */
    params.umi                = false 
    params.fastp              = false
    params.coyote_group       = "fusion"  // twistrnafusionv1-0, fusion, solidRNA_GMSv5 Change to RNA-fusion later when added
    params.assay              = "wts_rnafusion"     // rnaseqfusionpanel
    params.cdm                = "rnaseq-fusion" //solidRNA_GMSv5, twistrnafusionv1-0, rnaseq-fusion

    /*MET and EGFR exon skipping */
    params.exon_skipping      = false
    params.metEgfr            = "${params.data_refbase}/exon_skipping/Twist_RNA_Design5.hg38.annotated.bed"

    params.customDuxIgh       = true
    ighdux4                   = "${params.data_refbase}/IGH_DUX4/IGH_DUX4-reg_grch38.bed"

    params.arriba_filter      = true

    /* Change this parameter for the rnaseq whole transcriptp,ocs qc parameters */
    params.ref_flat                   = "/fs1/saile/prj/data/resources/WTS/gencode.v38.annotation.refflat"
    // params.ref_flat                = "${params.data_refbase}/st_rna/Cegat_genes_annotation.refflat"

    params.probes                     = "/fs1/saile/prj/data/resources/WTS/gencode.v38.interval_list"
    // params.probes                  = "${params.data_refbase}/st_rna/Cegat.targets.interval_list"

    params.targets                    = "/fs1/saile/prj/data/resources/WTS/gencode.v38.interval_list"
    // params.targets                 = "${params.data_refbase}/st_rna/Cegat.targets.interval_list"

    params.panel_bed                  = "/fs1/saile/prj/data/resources/WTS/sorted_gencode_v38.genes.bed"
    // params.panel_bed               = "${params.data_refbase}/st_rna/sorted_cegat_genes.bed"

    /* Expression profiles */
    params.quant                      = true
    
    /* Salmon */
    params.classifier                 = true
    params.ref_salmon                 = "${params.data_refbase}/transcriptome_ref/Homo_sapiens.GRCh38.cdna.all.fa"
    params.salmon_index_dir           = "${params.data_refbase}/transcriptome_ref/salmon_index/"

    /* Hem - Classifier */
    params.hem_classifier_salmon      = "${params.data_refbase}/fusion_classifier/hem_classifier.salmon.20190510.RData"
    params.ensembl_annotation         = "${params.data_refbase}/fusion_classifier/ensembl_annotation.RData"
    params.reference_expression_all   = "${params.data_refbase}/extract_expr_ref/reference_expression.all.tsv"
    params.genesOfInterest            = "${params.data_refbase}/extract_expr_ref/genes_of_interest.tsv"
  }

}

manifest {
  description                   = "A RNA seq fusion pipeline for tumor/normal or tumor sample"
  nextflowVersion               = "> 20.07.1"
}

includeConfig 'configs/modules.config'


trace {
  overwrite                     = true
}